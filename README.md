A program to load JSON files generated by 
[socialGen](https://github.com/huiwangcouchbase/socialGen.git) into 
[Couchbase](http://www.couchbase.com/).

This program can also be used to insert/update/delete/expire data in [Couchbase](http://www.couchbase.com/). 

This program can also be used to run [Couchbase Analytics SQL++ queries](https://developer.couchbase.com/documentation/server/4.5/analytics/1_intro.html).

After building the project with `mvn clean package`, a package (`*-binary-assembly*`) is available in the `target` directory.

A Jar file lib/loader-1.0-SNAPSHOT.jar is built which contains 4 main entries.

com.couchbase.bigfun.BatchModeLoaderEntry

This is a main entry which takes a json file as load generation parameters and run load (insert/delete/update/expire/run Analytics query) in a "batch" and paralleled way. 
The json file defines an array of load parameters, each load parameter defines how one load generation thread is created and generates the load. 
The load generation thread is ran in a "batch" style which means it will finish generating the load defined in the "data file"/"query file" in the load parameter and terminate.  

com.couchbase.bigfun.MixModeLoaderEntry

This is a main entry which takes a json file as load generation parameters and run load (insert/delete/update/expire/run Analytics query) in a "randomly mixed" and paralleled way.
The json file defines an array of load parameters, each load parameter defines how one load generation thread is created and generates the load. 
The load generation thread is ran in a "randomly mixed" style which means it will keep running for specified duration at the specified interval, and randomly pick different load to run. All these parameters are defined in the load parameter. 
 
com.couchbase.bigfun.BatchModeLoadParametersGeneratorEntry

This is a main entry which user can use to generate a batch mode load parameters file according to command parameters.

com.couchbase.bigfun.MixModeLoadParametersGeneratorEntry

This is a main entry which user can use to generate a mix mode load parameters file according to command parameters.

In load parameter, there is a DataInfo object containing information of the data file (of a data partition socialGen generated) used by the loader thread. 
The data generated by socialGen are partitioned, each partition is a folder contains json files of the 3 BigFun tables. The json file contains a subset of the whole table's data. 
For each partition json file, there is a associated meta file created with the ID range of the json file. Each load parameter contains a DataInfo object referencing a socialGen table partition json file (also referencing it's meta file).
Load parameter also contains a TargetInfo object which defines Couchbase information (for loader thread to access Couchbase/Analytics). Load parameter also contains some batch mode / mix mode specific parameters.

A batch mode loader will try to insert/delete/update/expire data in the data file (defined in the load parameter) sequentially it will terminate when all the data in the data file are done. It will also run all queries defined in the Analytics queries section sequentially and terminates when done.

A mix mode loader will randomly pick different operations according to operation propotion definition defined in load parameter, for insert opertion, it uses data as a template and randomly creates a non existing id / removed id and inserts the document, for update operation, mix mode loader will randomly pick a document and non removed id within the data file and update it, for delete / expire operation, the mix mode loader will randomly pick a non removed doc id from the data file and delete / expire it, for query operation, mix mode loader will randomly pick a query defined in the load parameter queries section and ran it.   

There are 5 main classes for each mode' loader, a Loader which is a thread that runs the load, a loader parameter which defines the load parameter associated with the loader, a load data object which provide data/query information for the loader, an loader entry which creates and runs loader threads according the load parameters file, a utility generator which helps creating load parameter json file.

Batch mode loader classes (important ones) are:

*BatchModeLoadParameter
*BatchModeLoader
*BatchModeLoaderEntry
*BatchModeLoadParametersGeneratorEntry
*BatchModeLoadData

Mix mode loader classes (important ones) are:

*MixModeLoadData
*MixModeLoadParameter
*MixModeLoadParametersGeneratorEntry
*MixModeLoader
*MixModeLoaderEntry

Here is a sample batch mode loader parameter file with just one loader defined:

```javascript
{
  "loadParameters": [
    {
      "operation": "insert",
      "updateParameter": {
        "updateFieldName": "id",
        "updateFieldType": "integer",
        "updateValuesFilePath": "",
        "updateValueStart": "1",
        "updateValueEnd": "100",
        "updateValueFormat": ""
      },
      "ttlParameter": {
        "expiryStart": 1,
        "expiryEnd": 2
      },
      "dataInfo": {
        "dataFilePath": "/workspace/bigfundata/p1/gbook_users.json",
        "metaFilePath": "/workspace/bigfundata/p1/gbook_users.meta",
        "keyFieldName": "id",
        "docsToLoad": 0
      },
      "targetInfo": {
        "host": "172.23.133.13",
        "bucket": "bucket-1",
        "username": "bucket-1",
        "password": "password",
        "cbashost": "172.23.133.11"
      },
      "queryInfo": {
        "queries": []
      }
    }
  ]
}
```

Here is a sample mix mode load parameter file (with one loader defined):

```javascript
{
  "loadParameters": [
    {
      "intervalMS": 50,
      "durationSeconds": 120,
      "startTime": "Oct 5, 2017 6:32:51 PM",
      "insertPropotion": 40,
      "updatePropotion": 40,
      "deletePropotion": 10,
      "ttlPropotion": 10,
      "queryPropotion": 0,
      "insertParameter": {
        "insertIdStart": 10000000
      },
      "deleteParameter": {
        "maxDeleteIds": 10
      },
      "ttlParameter": {
        "expiryStart": 1,
        "expiryEnd": 2
      },
      "dataInfo": {
        "dataFilePath": "/workspace/bigfundata/p1/gbook_users.json",
        "metaFilePath": "/workspace/bigfundata/p1/gbook_users.meta",
        "keyFieldName": "id",
        "docsToLoad": 1000
      },
      "targetInfo": {
        "host": "172.23.98.29",
        "bucket": "bucket-1",
        "username": "bucket-1",
        "password": "password",
        "cbashost": "172.23.98.30"
      },
      "queryInfo": {
        "queries": [
          "select * from GleambookUsers;",
          "select * from GleambookMessages;"
        ]
      }
    }
  ]
}
``` 



